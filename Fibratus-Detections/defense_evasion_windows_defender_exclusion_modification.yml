name: Windows Defender Exclusion Modification
id: a1234567-89ab-cdef-0123-456789abcdef
version: 1.0.0
description: >
  Windows Defender Exclusion Modification Detected:
  
  Detects modifications to Windows Defender exclusion lists via registry or PowerShell 
  commands. Attackers add malware paths, extensions, or process names to exclusions to 
  operate undetected. Common in ransomware attacks where actors exclude C:\ProgramData 
  or .exe files before deploying payloads, effectively creating blind spots in AV coverage.
  
  Normal: SCCM deployments, documented dev tool exclusions, IT-approved path exclusions
  Likely malicious: Excluding %TEMP%, %APPDATA%, .exe/.dll extensions, MpCmdRun with -ExclusionPath
enabled: true
labels:
  tactic.id: TA0005
  tactic.name: Defense Evasion
  tactic.ref: "https://attack.mitre.org/tactics/TA0005/"
  technique.id: T1562.001
  technique.name: Impair Defenses - Disable or Modify Tools
  technique.ref: "https://attack.mitre.org/techniques/T1562/001/"
tags:
  - windows defender
  - defense evasion
  - registry modification
  - command line
condition: >
  (
    kevt.name in ('RegSetValue', 'RegDeleteValue')
    and (
         registry.path icontains 'Windows Defender\\Exclusions\\Paths\\'
         or registry.path icontains 'Windows Defender\\Exclusions\\Extensions\\'
         or registry.path icontains 'Windows Defender\\Exclusions\\Processes\\'
    )
    and ps.name = 'MsMpEng.exe'
  )
  or
  (
    kevt.name = 'CreateProcess'
    and ps.name in ('MpCmdRun.exe')
    and kevt.arg[cmdline] contains 'MpPreference'
    and kevt.arg[cmdline] contains '-Exclusion'
  )
output: >
  Windows Defender Exclusion Modification Detected
  - Registry Key: %registry.key.name
  - Operation: %kevt.name

  Process Information:

  - Process Name: %ps.name 
  - Command Line: %ps.cmdline
  - Parent Process: %ps.parent.name (PPID: %ps.ppid)

  - Signature Status: %pe.is_signed
  - Cert Subject: %pe.cert.subject
  - Cert Issuer: %pe.cert.issuer
  - Process is Modified?: %pe.is_modified
  
min-engine-version: 2.0.0
