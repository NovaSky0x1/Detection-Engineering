name: HackTool - Default PowerSploit/Empire Scheduled Task Creation
id: 56c217c3-2de2-479b-990f-5c109ba8458f
version: 1.0.0
description: |
  PowerSploit/Empire scheduled task persistence detected:
  
  Detects the creation of a scheduled task via PowerSploit or Empire default configuration. 
  These tools create persistence through scheduled tasks with specific naming patterns and 
  command structures. The task typically named "Updater" executes PowerShell with non-interactive 
  flags and is triggered on various schedule types like logon, daily, idle, or hourly intervals.
labels:
  tactic.id: TA0003
  tactic.name: Persistence
  tactic.ref: https://attack.mitre.org/tactics/TA0003/
  technique.id: T1053
  technique.name: Scheduled Task/Job
  technique.ref: https://attack.mitre.org/techniques/T1053/
  subtechnique.id: T1053.005
  subtechnique.name: Scheduled Task
  subtechnique.ref: https://attack.mitre.org/techniques/T1053/005/
tags:
  - powersploit
  - empire
  - scheduled-task
  - persistence
  - attack.s0111
  - attack.g0022
  - attack.g0060
  - car.2013-08-001
references:
  - https://github.com/0xdeadbeefJERKY/PowerSploit/blob/8690399ef70d2cad10213575ac67e8fa90ddf7c3/Persistence/Persistence.psm1
  - https://github.com/EmpireProject/Empire/blob/08cbd274bef78243d7a8ed6443b8364acd1fc48b/lib/modules/powershell/persistence/userland/schtasks.py

condition: >
  spawn_process 
    and
  (ps.name ~= 'powershell.exe' or ps.name ~= 'pwsh.exe' or pe.file.name ~= 'powershell.exe')
    and
  (ps.child.name ~= 'schtasks.exe' or ps.child.pe.file.name ~= 'schtasks.exe')
    and
  (ps.child.cmdline icontains '/Create')
    and
  (ps.child.cmdline icontains 'powershell.exe -NonI')
    and
  (ps.child.cmdline icontains '/TN Updater /TR')
    and
  ((ps.child.cmdline icontains '/SC ONLOGON')
    or
   (ps.child.cmdline icontains '/SC DAILY /ST')
    or
   (ps.child.cmdline icontains '/SC ONIDLE')
    or
   (ps.child.cmdline icontains '/SC HOURLY'))

output: |
  PowerSploit/Empire scheduled task persistence detected
  
  Scheduled Task Creation Command: %ps.child.cmdline
  
  This indicates creation of a persistence mechanism using the default "Updater" task name
  commonly used by PowerSploit and Empire frameworks.
  
  Parent PowerShell Process: %ps.exe
  Parent Command Line: %ps.cmdline
  
  Process Information:
  
  - Process Name: %ps.name 
  - Command Line: %ps.cmdline
  - Parent Process: %ps.parent.name (PPID: %ps.ppid)
  
  - Signature Status: %pe.is_signed
  - Cert Subject: %pe.cert.subject
  - Cert Issuer: %pe.cert.issuer
  - Process is Modified?: %pe.is_modified

severity: high

min-engine-version: 2.0.0