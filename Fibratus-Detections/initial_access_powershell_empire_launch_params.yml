name: HackTool - Empire PowerShell Launch Parameters
id: 79f4ede3-402e-41c8-bc3e-ebbf5f162581
version: 1.0.0
description: |
  Empire PowerShell launch parameters detected:
  
  Detects suspicious PowerShell command line parameters commonly used by Empire framework 
  for launching encoded payloads. Empire typically uses specific combinations of PowerShell 
  flags to bypass security controls, hide windows, and execute base64-encoded commands. 
  These parameter combinations are highly indicative of Empire stager activity.
labels:
  tactic.id: TA0002
  tactic.name: Execution
  tactic.ref: https://attack.mitre.org/tactics/TA0002/
  technique.id: T1059
  technique.name: Command and Scripting Interpreter
  technique.ref: https://attack.mitre.org/techniques/T1059/
  subtechnique.id: T1059.001
  subtechnique.name: PowerShell
  subtechnique.ref: https://attack.mitre.org/techniques/T1059/001/
tags:
  - empire
  - powershell
  - encoded-command
references:
  - https://github.com/EmpireProject/Empire/blob/c2ba61ca8d2031dad0cfc1d5770ba723e8b710db/lib/common/helpers.py#L165
  - https://github.com/EmpireProject/Empire/blob/e37fb2eef8ff8f5a0a689f1589f424906fe13055/lib/modules/powershell/persistence/powerbreach/deaduser.py#L191
  - https://github.com/EmpireProject/Empire/blob/e37fb2eef8ff8f5a0a689f1589f424906fe13055/lib/modules/powershell/persistence/powerbreach/resolver.py#L178
  - https://github.com/EmpireProject/Empire/blob/e37fb2eef8ff8f5a0a689f1589f424906fe13055/data/module_source/privesc/Invoke-EventVwrBypass.ps1#L64

condition: >
  spawn_process 
    and
  (ps.child.name ~= 'powershell.exe' or ps.child.name ~= 'pwsh.exe' or ps.child.pe.file.name ~= 'powershell.exe')
    and
  ps.child.cmdline icontains
    (
      ' -NoP -sta -NonI -W Hidden -Enc ',
      ' -noP -sta -w 1 -enc ',
      ' -NoP -NonI -W Hidden -enc ',
      ' -noP -sta -w 1 -enc',
      ' -enc  SQB',
      ' -nop -exec bypass -EncodedCommand '
    )

output: |
  Empire PowerShell launch parameters detected
  
  Suspicious Command Line Pattern: %ps.child.cmdline
  
  Process Information:
  
  - Process Name: %ps.name 
  - Command Line: %ps.cmdline
  - Parent Process: %ps.parent.name (PPID: %ps.ppid)
  
  - Signature Status: %pe.is_signed
  - Cert Subject: %pe.cert.subject
  - Cert Issuer: %pe.cert.issuer
  - Process is Modified?: %pe.is_modified
  
severity: high

min-engine-version: 2.0.0