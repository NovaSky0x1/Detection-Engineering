name: CrackMapExec Execution Patterns
id: b162fa0f-8dbc-4b99-b483-77f9e659d44e
version: 1.0.0
description: |
  CrackMapExec Framework Detected:

  Detects command patterns specific to CrackMapExec (CME) post-exploitation framework. 
  CME automates network reconnaissance, credential harvesting, and lateral movement. 
  The tool's distinctive command patterns include output redirection to SMB shares 
  and specific PowerShell encoding formats used for remote execution.

  Normal: Never - these patterns are unique to CrackMapExec
  Likely malicious: cmd.exe redirecting to \\\\ paths, specific PowerShell encoding

enabled: true
labels:
  tactic.id: TA0002
  tactic.name: Execution
  tactic.ref: https://attack.mitre.org/tactics/TA0002/
  technique.id: T1047
  technique.name: Windows Management Instrumentation
  technique.ref: https://attack.mitre.org/techniques/T1047/

tags:
- crackmapexec
- lateral-movement

references:
- https://github.com/byt3bl33d3r/CrackMapExec

condition: >
  spawn_process
    and
  (
    ps.child.cmdline icontains 'cmd.exe /Q /c * 1> \\\\\\\\*\\\\*\\\\* 2>&1'
    or ps.child.cmdline icontains 'cmd.exe /C * > \\\\\\\\*\\\\*\\\\* 2>&1'
    or ps.child.cmdline icontains 'cmd.exe /C * > *\\\\Temp\\\\* 2>&1'
    or ps.child.cmdline icontains 'powershell.exe -exec bypass -noni -nop -w 1 -C "'
    or ps.child.cmdline icontains 'powershell.exe -noni -nop -w 1 -enc '
  )

output: |-
  CrackMapExec Framework

  CME Command Pattern: %ps.child.cmdline

  Process Information:

  - Process Name: %ps.name 
  - Command Line: %ps.cmdline
  - Parent Process: %ps.parent.name (PPID: %ps.ppid)

  - Signature Status: %pe.is_signed
  - Cert Subject: %pe.cert.subject
  - Cert Issuer: %pe.cert.issuer
  - Process is Modified?: %pe.is_modified

severity: high

min-engine-version: 2.0.0
