name: Ransomware In Progress - Memory-to-File Post-Overwrite
id: 1e1350b5-4562-4515-b3bd-fcd7db52dd13
version: 1.0.0
description: |
  Memory-To-File Post-Overwrite ransomeware pattern:
  
  Detects Cerber-style encryption where files are opened, read into memory for encryption, 
  written back encrypted, then subjected to additional operations (rename with .cerber extension 
  or deletion of originals). The 15ms window and file object tracking ensures accurate 
  detection of this memory-based encryption technique.
  
  Normal: Database compaction, legitimate file optimization tools, signed compression utilities
  Likely malicious: Same file object: open→read→write→write(size>0)→rename/delete/create <15ms
enabled: true

labels:
  tactic.id: TA0040
  tactic.name: Impact
  tactic.ref: https://attack.mitre.org/tactics/TA0040/
  technique.id: T1486
  technique.name: Data Encrypted for Impact
  technique.ref: https://attack.mitre.org/techniques/T1486/

tags:
  - ransomware
  - file-encryption
  - cerber

references:
  - https://attack.mitre.org/techniques/T1486/
  - https://github.com/rabbitstack/fibratus

condition: >
  sequence
    maxspan 15ms
    by file.object

    |(
      kevt.name = 'CreateFile'
      and file.operation = 'OPEN'
      and file.status = 'Success'

      and file.path imatches '?:\\Users\\*'
      and not file.path imatches '?:\\Users\\*\\AppData\\*'

      and not file.path imatches '?:\\Windows\\*'
      and not file.path imatches '?:\\Program Files*'
      and not file.path imatches '?:\\ProgramData\\*'

      and not (
        ps.name in (
          'OneDrive.exe',
          'Dropbox.exe',
          'GoogleDriveFS.exe',
          'BoxSync.exe',
          'BackupService.exe',
          'SafeBackup.exe'
        )
      )
    )|
    |(
      kevt.name = 'ReadFile'
      and file.path imatches '?:\\Users\\*'
      and not file.path imatches '?:\\Users\\*\\AppData\\*'
      and not file.path imatches '?:\\Windows\\*'
      and not file.path imatches '?:\\Program Files*'
      and not file.path imatches '?:\\ProgramData\\*'
    )|
    |(
      kevt.name = 'WriteFile'
      and file.path imatches '?:\\Users\\*'
      and not file.path imatches '?:\\Users\\*\\AppData\\*'
      and not file.path imatches '?:\\Windows\\*'
      and not file.path imatches '?:\\Program Files*'
      and not file.path imatches '?:\\ProgramData\\*'
    )|
    |(
      kevt.name = 'WriteFile'
      and file.io.size > 0
      and file.path imatches '?:\\Users\\*'
      and not file.path imatches '?:\\Users\\*\\AppData\\*'
      and not file.path imatches '?:\\Windows\\*'
      and not file.path imatches '?:\\Program Files*'
      and not file.path imatches '?:\\ProgramData\\*'
    )|
    |(
      (
        kevt.name = 'RenameFile'
      )
      or
      (
        kevt.name = 'FileDelete'
      )
      or
      (
        kevt.name = 'FileCreate'
      )
    )|

output: |
  Memory-To-File Post-Overwrite by %ps.name on %file.name:
  open/read/write twice, then rename/delete/create. This is a common file modification pattern ransomeware takes.

  Process Information:

  - Process Name: %ps.name 
  - Command Line: %ps.cmdline
  - Parent Process: %ps.parent.name (PPID: %ps.ppid)

  - Signature Status: %pe.is_signed
  - Cert Subject: %pe.cert.subject
  - Cert Issuer: %pe.cert.issuer
  - Process is Modified?: %pe.is_modified

severity: critical

min-engine-version: 2.0.0
