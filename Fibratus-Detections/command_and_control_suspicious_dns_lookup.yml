name: Suspicious DNS Query Detection
id: a5e6d8f2-74b1-4c3e-bb4a-9c2d58e3f0d2
version: 1.4.0
description: |
  Suspicious DNS Query Detected:
  
  Detects suspicious DNS queries indicating command and control (C2) communications, data 
  exfiltration via DNS tunneling, or domain generation algorithm (DGA) activity. Monitors 
  for queries to known malicious TLDs, file-sharing services commonly abused by infostealers, 
  and dynamic DNS providers used for C2 infrastructure. These domains are frequently used 
  in malware campaigns for data theft, command relay, and payload distribution.
  
  Normal: Corporate file-sharing via approved services, legitimate ngrok for dev testing by IT
  Likely malicious: Non-browser processes querying file.io/mega.nz, .tk/.xyz domains, multiple DGA-like queries

enabled: true

labels:
  tactic.id: TA0011
  tactic.name: Command and Control
  tactic.ref: https://attack.mitre.org/tactics/TA0011/
  technique.id: T1071
  technique.name: Application Layer Protocol
  technique.ref: https://attack.mitre.org/techniques/T1071/
  subtechnique.id: T1071.004
  subtechnique.name: DNS
  subtechnique.ref: https://attack.mitre.org/techniques/T1071/004/

tags:
  - dns exfiltration
  - command and control
  - dns tunneling
  - infostealer
  - file upload abuse

references:
  - https://attack.mitre.org/techniques/T1071/004/
  - https://redcanary.com/threat-detection-report/dns-tunneling/
  - https://www.sans.org/blog/detecting-dns-tunneling/

condition: >
  query_dns
    and dns.name in (
      'ngrok.io',
      'pastebin.com',
      'discordapp.com',
      '.onion',
      '.top',
      '.xyz',
      '.tk',
      'limewire.com',
      '.bit',
      '.ir',
      '.ru',
      '.dyn',
      '.no-ip',
      '.duckdns',
      'file.io',
      'anonfiles.com',
      'bayfiles.com',
      'wetransfer.com',
      'sendspace.com',
      'filedropper.com',
      'mega.nz',
      'transfer.sh',
      'pixeldrain.com',
      'gofile.io',
      'zippyshare.com'
    )
    and dns.name not contains 'microsoft.com'
    and dns.name not contains 'windows.com'
    and dns.name not contains 'windowsupdate.microsoft.com'
    and ps.exe not icontains 'CloudJacketAgent.exe'
    and ps.parent.exe not icontains 'CloudJacketAgent.exe'

output: |
  Suspicious DNS Query Detected!
  - Queried Domain: %dns.name
  
  Process Information:

  - Process Name: %ps.name 
  - Command Line: %ps.cmdline
  - Parent Process: %ps.parent.name (PPID: %ps.ppid)

  - Signature Status: %pe.is_signed
  - Cert Subject: %pe.cert.subject
  - Cert Issuer: %pe.cert.issuer
  - Process is Modified?: %pe.is_modified

min-engine-version: 2.0.0
