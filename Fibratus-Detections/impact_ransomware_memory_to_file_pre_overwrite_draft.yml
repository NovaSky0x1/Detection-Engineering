name: Ransomware In Progress - Memory-to-File Pre-Overwrite
id: a72a98a9-d230-41e7-af68-c3e5105f3a2e
version: 1.0.2
description: |
  Memory-to-file pre-overwrite ransomware pattern:
  
  Detects immediate file corruption pattern where ransomware opens files, renames them to 
  backup copies, then overwrites originals with encrypted content. This rapid 2ms sequence 
  prevents file recovery by immediately corrupting original data. Common in wiper malware 
  and destructive ransomware variants.
  
  Normal: Transactional file systems, journaled editors, operations >5ms apart
  Likely malicious: Unsigned: open→rename immediately→write(size>0) <2ms in user folders
enabled: true

labels:
  tactic.id: TA0040
  tactic.name: Impact  
  tactic.ref: https://attack.mitre.org/tactics/TA0040/
  technique.id: T1486
  technique.name: Data Encrypted for Impact
  technique.ref: https://attack.mitre.org/techniques/T1486/
  
tags:
  - ransomware
  - file-encryption

references:
  - https://attack.mitre.org/techniques/T1486/

condition: >
  sequence
    maxspan 2ms 
    by ps.uuid

    |(
      (
        image.signature.type = 'NONE'
          or
        image.signature.level = 'UNCHECKED'
          or
        pe.is_trusted = false
      )
        and
      kevt.name = 'CreateFile' 
      and file.operation = 'OPEN'
      and file.status = 'Success'
      and file.path imatches 
        (
          '?:\\Users\\*\\Desktop\\*',
          '?:\\Users\\*\\Documents\\*', 
          '?:\\Users\\*\\Downloads\\*',
          '?:\\Users\\*\\Pictures\\*'
        )
      and not file.name iendswith
        (
          'desktop.ini',
          '.tmp',
          '.lnk',
          '.url',
          '.ini'
        )
      and not ps.exe imatches '?:\\Program Files*'
      and not (
        ps.name in (
          'OneDrive.exe',
          'Dropbox.exe',
          'BackupService.exe',
          'GoogleDriveFS.exe',
          'BoxSync.exe',
          'SafeBackup.exe',
          'explorer.exe',
          'RuntimeBroker.exe',
          'svchost.exe'
        )
      )
    )|

    |(
      kevt.name = 'RenameFile'
      and file.path imatches 
        (
          '?:\\Users\\*\\Desktop\\*',
          '?:\\Users\\*\\Documents\\*', 
          '?:\\Users\\*\\Downloads\\*',
          '?:\\Users\\*\\Pictures\\*'
        ) 
      and not file.name iendswith
        (
          'desktop.ini',
          '.tmp',
          '.lnk',
          '.url',
          '.ini'
        )
    )|  

    |(
      kevt.name = 'WriteFile'
      and file.io.size > 0
      and file.path imatches 
        (
          '?:\\Users\\*\\Desktop\\*',
          '?:\\Users\\*\\Documents\\*', 
          '?:\\Users\\*\\Downloads\\*',
          '?:\\Users\\*\\Pictures\\*'
        )
      and not file.name iendswith
        (
          'desktop.ini',
          '.tmp',
          '.lnk',
          '.url',
          '.ini'
        )
    )|

output: |
  Memory-to-file pre-overwrite by %ps.name on %file.name. This is a common file modification pattern ransomeware takes.
  
  Process Information:

  - Process Name: %ps.name 
  - Command Line: %ps.cmdline
  - Parent Process: %ps.parent.name (PPID: %ps.ppid)

  - Signature Status: %pe.is_signed
  - Cert Subject: %pe.cert.subject
  - Cert Issuer: %pe.cert.issuer
  - Process is Modified?: %pe.is_modified
  
severity: critical

min-engine-version: 2.0.0
