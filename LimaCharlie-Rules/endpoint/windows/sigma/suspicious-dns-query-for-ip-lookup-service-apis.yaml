# Suspicious DNS Query for IP Lookup Service APIs
# LimaCharlie D&R Rule
# Author: Brandon George (blog post), Thomas Patzke
# Severity: medium

detect:
  event: DNS_REQUEST
  op: and
  rules:
  - op: or
    rules:
    - op: or
      rules:
      - case sensitive: false
        op: is
        path: event/DOMAIN_NAME
        value: www.ip.cn
      - case sensitive: false
        op: is
        path: event/DOMAIN_NAME
        value: l2.io
    - op: or
      rules:
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: api.2ip.ua
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: api.bigdatacloud.net
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: api.ipify.org
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: bot.whatismyipaddress.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: canireachthe.net
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: checkip.dyndns.org
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: curlmyip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: db-ip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: eth0.me
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: freegeoip.app
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: icanhazip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ifconfig.me
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ip-api.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipapi.co
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipecho.net
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipinfo.io
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: ipwho.is
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: myexternalip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: wtfismyip.com
      - case sensitive: false
        op: contains
        path: event/DOMAIN_NAME
        value: whatismyip.akamai.com
  - not: true
    op: or
    rules:
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \brave.exe
    - op: or
      rules:
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files\Google\Chrome\Application\chrome.exe
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files (x86)\Google\Chrome\Application\chrome.exe
    - op: or
      rules:
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files\Mozilla Firefox\firefox.exe
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files (x86)\Mozilla Firefox\firefox.exe
    - op: or
      rules:
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe
      - case sensitive: false
        op: is
        path: event/FILE_PATH
        value: C:\Program Files\Microsoft\Edge\Application\msedge.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \opera.exe
    - case sensitive: false
      op: ends with
      path: event/FILE_PATH
      value: \vivaldi.exe
respond:
- action: report
  metadata:
    author: Brandon George (blog post), Thomas Patzke
    description: Detects DNS queries for IP lookup services such as api.ipify.org originating from a non browser process.
    falsepositives:
    - Legitimate usage of IP lookup services such as ipify API
    level: medium
    references:
    - https://www.binarydefense.com/analysis-of-hancitor-when-boring-begets-beacon
    - https://www.trendmicro.com/en_us/research/23/e/managed-xdr-investigation-of-ducktail-in-trend-micro-vision-one.html
    tags:
    - attack.reconnaissance
    - attack.t1590
  name: Suspicious DNS Query for IP Lookup Service APIs
