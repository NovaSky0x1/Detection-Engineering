# M365 - Login After Password Change from Different IP
# LimaCharlie D&R Rule
# Author: Joshua Strickland
# Severity: high

detect:
  events:
  - Change user password.
  - Reset user password.
  op: exists
  path: event/ObjectId
  with events:
    count: 1
    event: UserLoggedIn
    op: and
    rules:
    - op: exists
      path: event/UserId
    - not: true
      op: is
      path: event/ClientIP
      value: '{{ .event.ClientIP }}'
    within: 3600
respond:
- action: report
  metadata:
    author: Joshua Strickland
    description: A login occurred from a different IP address shortly after a password change/reset. This is a strong indicator
      of account takeover.
    false_positives:
    - User resetting password from one device, then logging in from another
    - IT helpdesk resetting password for user
    investigation_steps:
    - Identify who initiated the password reset
    - Compare the IPs - are they geographically distant?
    - Contact the user to verify the password reset was legitimate
    - Check for MFA changes around the same time
    mitre_attack:
    - T1078 - Valid Accounts
    - T1098 - Account Manipulation
    references:
    - https://attack.mitre.org/techniques/T1078/
    severity: high
  name: M365 - Login After Password Change from Different IP
  suppression:
    is_global: true
    keys:
    - '{{ .event.ObjectId }}'
    - m365-pwd-ip-change
    max_count: 1
    period: 1h
