# M365 - Workload Identity Federation Credential Added
# LimaCharlie D&R Rule
# Author: Joshua Strickland
# Severity: critical

detect:
  event: Add federated identity credential
  op: exists
  path: event/Operation
respond:
- action: report
  metadata:
    author: Joshua Strickland
    description: A federated identity credential was added to a service principal or managed identity. Attackers abuse this
      feature to establish persistent backdoor access from infrastructure they control by configuring federation to trust
      an attacker-controlled identity provider.
    false_positives:
    - Legitimate GitHub Actions or Azure DevOps pipeline configurations
    - Multi-cloud integration setups
    - Infrastructure-as-Code deployments using workload identity
    - Kubernetes workload identity configurations
    - Third-party CI/CD platform integrations
    investigation_steps:
    - Identify which service principal received the federated credential
    - Review the issuer URL and subject claim
    - Determine if the issuer is a known legitimate identity provider
    - Check the permissions assigned to the service principal
    - Verify the user account that configured the federation
    - Review if this aligns with known DevOps projects
    - Check for any usage of the federated credential after configuration
    - Look for suspicious subject claims
    mitre_attack:
    - T1098.001 - Account Manipulation: Additional Cloud Credentials
    - T1550.001 - Use Alternate Authentication Material: Application Access Token
    - T1199 - Trusted Relationship
    references:
    - https://attack.mitre.org/techniques/T1098/001/
    - https://attack.mitre.org/techniques/T1550/001/
    - https://attack.mitre.org/techniques/T1199/
    - https://docs.microsoft.com/en-us/azure/active-directory/develop/workload-identity-federation
    severity: critical
  name: M365 - Workload Identity Federation Credential Added
  suppression:
    is_global: true
    keys:
    - '{{ .event.ObjectId }}'
    - m365-wif-credential
    max_count: 2
    period: 24h
