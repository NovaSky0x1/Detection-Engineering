# M365 - Service Principal Credential Added
# LimaCharlie D&R Rule
# Author: Joshua Strickland
# Severity: high

detect:
  events:
  - Add service principal credentials
  - Update application – Certificates and secrets management
  - Update service principal
  op: or
  rules:
  - op: is
    path: event/Operation
    value: Add service principal credentials
  - op: is
    path: event/Operation
    value: Update application – Certificates and secrets management
  - op: and
    rules:
    - op: is
      path: event/Operation
      value: Update service principal
    - op: is
      path: event/ModifiedProperties/?/Name
      value: KeyDescription
    - op: exists
      path: event/ModifiedProperties/?/NewValue
respond:
- action: report
  metadata:
    author: Joshua Strickland
    description: A new credential (client secret or certificate) was added to a service principal or application registration.
      Attackers add credentials to existing service principals to establish persistent access that survives password resets,
      bypasses MFA, and operates independently of user accounts.
    false_positives:
    - Legitimate application credential rotation by DevOps teams
    - New automation or integration deployments
    - Expired credential replacement for production services
    - Development and testing of service principal authentication
    - Scheduled security credential updates per policy
    investigation_steps:
    - Identify which service principal had credentials added
    - Verify the user account that added the credential
    - Review the permissions and roles assigned to the service principal
    - Check the credential expiration date (never-expiring is highly suspicious)
    - Examine recent login activity for the administrator account
    - Review what resources the service principal has access to
    - Check for any unusual API calls or resource access after credential addition
    - Verify if there was a legitimate change request or ticket
    mitre_attack:
    - T1098.001 - Account Manipulation: Additional Cloud Credentials
    - T1136.003 - Create Account: Cloud Account
    - T1550.001 - Use Alternate Authentication Material: Application Access Token
    references:
    - https://attack.mitre.org/techniques/T1098/001/
    - https://attack.mitre.org/techniques/T1550/001/
    - https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal
    severity: high
  name: M365 - Service Principal Credential Added
  suppression:
    is_global: true
    keys:
    - '{{ .event.ObjectId }}'
    - m365-sp-credential
    max_count: 3
    period: 24h
